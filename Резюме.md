
---

# **РЕЗЮМЕ ПРОЕКТА «СИСТЕМА БРОНИРОВАНИЯ СТОЛИКОВ»**

## **1. Общая концепция и цели**

1. **Основная идея**  
    Система должна позволять:
    
    - Создавать и управлять бронированиями столиков в ресторанах (и, в будущем, в других заведениях).
    - Разграничивать доступ к функционалу между обычными администраторами и «супер-администратором».
    - Масштабироваться под несколько заведений, включая отдельно стоящие рестораны, разные корпуса отелей (банкетные залы и т.д.).
2. **Роли**
    
    - **Супер-админ**: может создавать новые заведения (`Properties`), управлять всеми данными во всей системе.
    - **Администраторы** (прочие пользователи, кроме супер-админа): управляют существующими заведениями, залами, столами, бронированиями.
    - **Гости** (будущий функционал, «auto»-бронирования): могут в дальнейшем бронировать столики через клиентское приложение/сайт, указывая телефон и/или email, без полноценного ЛК.
3. **Ключевые задачи**
    
    1. **Удобство**: предоставить простой интерфейс администратору, чтобы он мог быстро создавать, подтверждать или отменять бронирования.
    2. **Безопасность**: хранить пароли пользователей (администраторов) в зашифрованном виде, разграничивать действия по ролям.
    3. **Расширяемость**: поддержка дополнительных модулей (банкетные бронирования, платежи через ЮMoney, рассылки на email, визуальная карта зала и т.д.).
    4. **Статистика**: сбор данных по бронированиям, выгрузка в Excel/CSV, отслеживание действий (логирование).

---

## **2. Структура базы данных**

Ниже описана базовая схема таблиц; часть полей и логики заложена на перспективу.

1. **`Properties`** (Заведения)
    
    - `property_id` (PK)
    - `property_name`
    - `address` (строка с адресом)
    - `contact_info` (телефоны, email и т.д.)
2. **`Halls`** (Залы внутри заведения)
    
    - `hall_id` (PK)
    - `hall_name`
    - `property_id` (FK → `Properties.property_id`)
3. **`Tables`** (Столы в конкретном зале)
    
    - `table_id` (PK)
    - `hall_id` (FK → `Halls.hall_id`)
    - `table_capacity` (до 5, но в будущем может быть больше)
    - `table_label` (например, «Стол №5 у окна»)
4. **`Booking_types`** (Тип бронирования)
    
    - `booking_type_id` (PK)
    - `booking_type_name` (например, `manual` или `auto`; в будущем — «banquet» и т.д.)
5. **`Booking_statuses`** (Статусы бронирования)
    
    - `booking_status_id` (PK)
    - `booking_status_name` (например, `Pending`, `Confirmed`, `Canceled`)
6. **`Bookings`** (Основная таблица с бронированиями)
    
    - `booking_id` (PK)
    - `property_id` (FK → `Properties.property_id`)
    - `table_id` (FK → `Tables.table_id`)
    - **Дата и время**:
        - `booking_date` (тип `DATE`)
        - `booking_time` (тип `TIME`)
    - `phone`
    - `customer_name`
    - `person_count` (сколько гостей)
    - `commentary` (любые дополнительные пожелания)
    - `booking_type_id` (FK → `Booking_types.booking_type_id`)
    - `booking_status_id` (FK → `Booking_statuses.booking_status_id`)
    - `booking_timestamp` (время создания записи, тип `TIMESTAMP`)
    - (На будущее) поля для «оплачено/не оплачено» или ссылка на платеж.
7. **`Users`** (Пользователи)
    
    - `user_id` (PK)
    - `username` (логин)
    - `password_hash` (хранение хэша пароля; планируется bcrypt или другой надёжный метод)
    - `role` (например, `super_admin`, `admin`)
    - `property_id` (если админ привязан к конкретному заведению; для супер-админа может быть `NULL`)
8. **`Payments`** (планируется для ЮMoney и прочих платежей)
    
    - `payment_id` (PK)
    - `booking_id` (FK → `Bookings.booking_id`)
    - `payment_amount` (сумма)
    - `payment_date`
    - `payment_status` (например, «succeeded», «failed», «pending»)
    - Другие поля (способ оплаты, комментарии).
9. **`Booking_logs`** (логирование действий) – по желанию
    
    - `log_id` (PK)
    - `booking_id` (FK → `Bookings.booking_id`)
    - `action` (например, «create», «update», «status_change»)
    - `old_status`, `new_status` (или `old_value`, `new_value`)
    - `changed_by_user_id` (кто внёс изменение)
    - `changed_at` (дата-время изменения)

> **Примечание**: логирование действий и таблица `Payments` — не обязательны на старте, но удобнее заложить сразу схему.

---

## **3. Основные потоки работы**

### 3.1 Ручное бронирование (manual)

1. Администратор выбирает заведение (`Properties`), зал (`Halls`), стол (`Tables`) и сразу указывает дату/время, данные клиента.
2. Тип бронирования (`booking_type_id`) = `manual`.
3. Статус по умолчанию сразу `Confirmed`, так как администратор уже «ручным» способом связался с гостем.
4. При необходимости администратор может менять статус на `Canceled`, если клиент отказался, или на «No-show» (если добавим такой статус в будущем).

### 3.2 Автоматическое бронирование (auto)

1. Пока не реализовано, но планируется, что клиент (гость) может выбрать стол через сайт (React-приложение).
2. Тип = `auto`.
3. Статус сначала `Pending`.
4. При интеграции платежей (ЮMoney) после успешной оплаты статус меняется на `Confirmed`. Если оплата не проходит – либо `Canceled`, либо остаётся `Pending` до истечения тайм-аута.

### 3.3 Банкет (пока отложено)

- Возможно, это будет отдельный тип бронирования (`booking_type_name = 'banquet'`) или отдельная логика (бронируется целый зал).
- Администратор сам подтверждает, обзванивает, никаких предоплат (по текущему описанию).
- Стол (или залы) могут быть помечены как «заняты» на нужное время для проведения банкета.

---

## **4. Бизнес-правила**

1. **Пересечение бронирований**
    
    - Для одного стола в один промежуток времени не может быть двух бронирований. Не допускаем «овербукинг».
    - Если гость хочет изменить время, нужно проверять, не занято ли это время другим бронированием.
2. **Разграничение доступа**
    
    - **Супер-админ**: добавляет/редактирует любые заведениия, залы и столы, видит все бронирования.
    - **Администратор**: может управлять заведением, к которому прикреплён (через `property_id`), а также залами, столами и бронированиями в пределах своего заведения.
    - **Гость** (в перспективе): может только создавать «auto»-бронирование, редактировать или отменять **своё** бронирование (с дополнительной логикой подтверждения).
3. **Оплата**
    
    - Будет реализована через ЮMoney.
    - При «auto»-бронировании система генерирует заказ и перенаправляет на страницу оплаты. После ответа от платёжной системы бронирование переводится в `Confirmed`.
4. **Уведомления**
    
    - В будущем планируется отправка писем на email клиентам (о подтверждении, отмене).
    - Также возможна массовая рассылка (например, акций или напоминаний).
5. **Статистика и отчётность**
    
    - Позже добавляется модуль для выгрузки бронирований в Excel/CSV.
    - Полезно для анализа загрузки заведения, динамики, популярности столов и т.д.

---

## **5. API (планируемые эндпоинты)**

1. **Справочная информация**
    
    - `GET /api/booking_types`
    - `GET /api/booking_statuses`
2. **Заведения**
    
    - `GET /api/properties` – список заведений
    - `POST /api/properties` – (только для супер-админа) создать новое заведение
    - и т.д.
3. **Залы**
    
    - `GET /api/halls` (с фильтром `property_id`, если нужно)
    - `POST /api/halls` – создать зал
    - `PUT /api/halls/:id` – обновить
    - `DELETE /api/halls/:id` – удалить
4. **Столы**
    
    - `GET /api/tables` (фильтр по `hall_id`)
    - `POST /api/tables` – добавить стол в зал
    - `PUT /api/tables/:id` – обновить
    - `DELETE /api/tables/:id` – удалить
5. **Бронирования**
    
    - `GET /api/bookings` – получить список всех бронирований (с опциональной фильтрацией по дате, статусу, заведению)
    - `POST /api/bookings` – создать бронирование (`manual` или `auto`)
        - При `manual` сразу `Confirmed`
        - При `auto` → `Pending`
    - `PUT /api/bookings/:id` – обновить бронирование (изменить статус, время и т.д.)
    - `DELETE /api/bookings/:id` – удалить (отменить)
6. **Пользователи**
    
    - `GET /api/users` – список пользователей (только для супер-админа)
    - `POST /api/users` – добавить нового пользователя (опционально: если требуются админские учётные записи)

> **На перспективу**: отдельные маршруты для логирования (`/api/logs`) и платежей (`/api/payments`), если придёт время детально интегрировать это в API.

---

## **6. Технические аспекты**

1. **Node.js + Express** на бэкенде.
    
    - Подключение к MySQL через `mysql2/promise`.
    - Используем модульную структуру (папки `routes`, `models`, возможно, `controllers`).
2. **React** на фронтенде (пока в зачаточном состоянии).
    
    - Планируется страница с формами для создания бронирований, списка бронирований, управление залами/столами.
    - В будущем: визуальная карта (drag-and-drop расположения столов).
3. **Безопасность**
    
    - Пароли храним в виде хэша (bcrypt).
    - В `.env` будут храниться секреты (например, `JWT_SECRET`, данные для подключения к БД, ключи ЮMoney).
    - Возможна реализация JWT-токенов для аутентификации.
4. **Миграции БД**
    
    - При первом запуске или при развёртывании на новом сервере создаём все таблицы.
    - Заполняем служебные таблицы (`booking_types`, `booking_statuses`) базовыми записями (`manual`, `auto`, `Pending`, `Confirmed`, `Canceled`).
5. **Логика пересечения бронирований**
    
    - При `POST /api/bookings` (и `PUT`, если меняется время) сервер проверяет, нет ли другого бронирования для того же `table_id` на ту же дату и пересекающийся интервал времени.
    - Если есть пересечение, возвращаем ошибку (например, `400` — «Стол уже забронирован на эти часы»).
6. **Планируемый формат времени**
    
    - Для хранения: `DATE` и `TIME` поля.
    - В коде Node.js получаем их как строки формата `YYYY-MM-DD` и `HH:MM:SS` (или `HH:MM`).
    - Сравнение интервалов делаем через SQL или на уровне JavaScript (например, конвертация в минуты).

---

## **7. Будущее развитие**

1. **Интеграция платежей**
    
    - Создать таблицу `Payments`, привязать к `Bookings`.
    - При «auto»-бронировании («Pending») генерировать платёжную сессию в ЮMoney.
    - После ответа от ЮMoney менять статус бронирования на «Confirmed» или «Canceled».
2. **Логирование изменений**
    
    - Создать `Booking_logs`.
    - Записывать, кто и когда менял бронирование (особенно актуально при нескольких администраторах).
3. **Визуальная карта зала**
    
    - Хранить у каждого `Tables` дополнительные координаты (`pos_x`, `pos_y`) и размеры (если нужно).
    - Сделать drag-and-drop интерфейс для администраторов.
    - Для клиентов – интерактивную схему, где занятые столики отображаются в режиме «серым цветом» и т. д.
4. **Массовые рассылки**
    
    - При подтверждении бронирования – отправляем письмо клиенту, возможно, SMS (через провайдера).
    - При отмене – тоже уведомляем.
    - Массовая рассылка (акции) – отдельная логика (нужно согласие клиента и т. д.).
5. **Учет банкетов**
    
    - Вариант 1: отдельный `booking_type` = `'banquet'`. При таком заказе администратор блокирует весь `hall_id` на нужное время.
    - Вариант 2: отдельная таблица «Banquet_halls» (но, скорее, избыточно).
    - Возможно, дополнительное поле `is_whole_hall_reserved`, если «банкет» закрывает доступ к любым столикам данного зала.

---

## **8. Выводы**

- **Система** уже на старте должна позволять создавать и управлять бронированиями (Manual/Auto), хранить базовую информацию о заведениях, столах, пользователях.
- **Супер-админ** – ключевая роль, создаёт `Properties`.
- **Администраторы** – работают в рамках своих заведений, создают «manual» бронирования, подтверждают «auto» при успешной оплате.
- **Гости** (в будущем) будут осуществлять «auto»-бронирование через веб-интерфейс/React-приложение.
- **Пересечения** по времени строго отслеживаются для каждого отдельного `table_id`.
- **Статистика**, **экспорт в Excel**, **логирование**, **банкетные бронирования** – всё это планируется на более продвинутых этапах.
